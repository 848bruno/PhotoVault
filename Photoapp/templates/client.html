{% extends "base.html" %}

{% block title %}Client Portal - My Photos{% endblock %}

{% block auth_buttons %}
    <button class="btn-logout" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i>
        <span class="d-none d-md-inline">Log Out</span>
    </button>
{% endblock %}

{% block sidebar %}
    <nav class="sidebar">
        <div class="sidebar-section">
            <h6 class="sidebar-section-title">Gallery</h6>
            <a href="{% url 'client' %}" class="sidebar-link active">
                <i class="fas fa-images"></i>
                <span>Gallery</span>
            </a>
            <a href="{% url 'cart' %}" class="sidebar-link">
                <i class="fas fa-shopping-cart"></i>
                <span>Cart</span>
                <span class="badge bg-pv-light rounded-pill ms-auto" id="sidebar-cart-count">0</span>
            </a>
        </div>
        
        <div class="sidebar-section">
            <h6 class="sidebar-section-title">Orders</h6>
            <a href="{% url 'trackOrder' %}" class="sidebar-link">
                <i class="fas fa-shipping-fast"></i>
                <span>Track Order</span>
            </a>
            <a href="{% url 'orderHistory' %}" class="sidebar-link">
                <i class="fas fa-history"></i>
                <span>Order History</span>
            </a>
        </div>
        
        <div class="sidebar-section">
            <h6 class="sidebar-section-title">Account</h6>
            <a href="#" class="sidebar-link">
                <i class="fas fa-user-cog"></i>
                <span>Profile Settings</span>
            </a>
            <a href="#" class="sidebar-link">
                <i class="fas fa-credit-card"></i>
                <span>Payment Methods</span>
            </a>
        </div>
    </nav>
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <!-- Gallery Header -->
    <div class="gallery-header bg-pv-very-light py-4 px-4 mb-4">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
            <h1 class="h2 mb-0 text-pv-deep">
                <i class="fas fa-images me-2"></i>
                My Photo Gallery
            </h1>
            <div class="d-flex align-items-center gap-3 mt-2 mt-md-0">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-pv-outline btn-sm active" onclick="filterPhotos('all')">
                        All Photos
                    </button>
                    <button type="button" class="btn btn-pv-outline btn-sm" onclick="filterPhotos('preview')">
                        Preview Only
                    </button>
                    <button type="button" class="btn btn-pv-outline btn-sm" onclick="filterPhotos('purchased')">
                        Purchased Only
                    </button>
                </div>
                <button class="sidebar-toggle d-lg-none" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
    </div>

<div class="mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="text-contrast">
            <i class="fas fa-eye me-2 text-pv-light"></i>
            Preview Photos
            <span class="badge bg-secondary ms-2" id="preview-count">
                {{ photos|length }} photos
            </span>
        </h3>

        <div class="d-flex align-items-center gap-2">
            <button class="btn-pv-outline btn-sm" onclick="selectAllPreview()">
                <i class="fas fa-check-square me-1"></i> Select All
            </button>
            <button class="btn-pv-primary btn-sm" onclick="addSelectedToCart()">
                <i class="fas fa-cart-plus me-1"></i> Add to Cart
            </button>
        </div>
    </div>

    <p class="text-muted mb-4">
        These photos are available for purchase. Add them to your cart to buy digital copies or order physical prints.
    </p>

    <div class="row g-4" id="preview-photos">

        {% for photo in photos %}
        <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="photo-card card h-100" data-type="preview">
                <div class="position-relative">
                    <img src="{{ photo.image.url }}" 
                         alt="Photo" 
                         class="card-img-top">

                    <div class="position-absolute top-0 end-0 m-2">
                        <div class="form-check">
                            <input class="form-check-input photo-checkbox"
                                   type="checkbox"
                                   value="{{ photo.id }}">
                        </div>
                    </div>

                    <div class="position-absolute top-0 start-0 m-2">
                        <span class="badge bg-warning text-dark">Preview</span>
                    </div>
                </div>

                <div class="card-body">
                    <h5 class="card-title">{{ photo.category }}</h5>

                    <p class="card-text small text-muted">
                        <i class="fas fa-calendar-alt me-1"></i>
                        Uploaded: {{ photo.uploaded_at|date:"M d, Y" }}<br>

                        <i class="fas fa-tag me-1"></i>
                        Category: {{ photo.category }}<br>

                        <i class="fas fa-camera me-1"></i>
                        Resolution: Unknown
                    </p>

                    <div class="d-flex justify-content-between align-items-center">
                        <div class="price-section">
                            <span class="text-pv-light fw-bold h5 mb-0">
                                KSH {{ photo.price }}
                            </span>
                            <small class="text-muted d-block">Digital Copy</small>
                        </div>

                        <div class="btn-group">
                            <button class="btn btn-pv-outline btn-sm" onclick="addToCart(this, '{{ photo.id }}')">
                                <i class="fas fa-shopping-cart me-1"></i> Add
                            </button>

                            <button class="btn btn-pv-primary btn-sm" onclick="quickBuy(this, '{{ photo.id }}')">
                                <i class="fas fa-bolt me-1"></i> Buy Now
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>


 

    <!-- Purchased Photos Section -->
    <div class="mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
        
            <div class="d-flex align-items-center gap-2">
                
            </div>
        </div>
        
        <p class="text-muted mb-4"></p>
        
        <div class="row g-4" id="purchased-photos">
           
     <!-- Purchased Photos Section -->
<div class="mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="text-contrast">
            <i class="fas fa-check-circle me-2 text-success"></i>
            Purchased Photos
            <span class="badge bg-success ms-2">{{ purchased_count }} photos</span>
        </h3>

        <button class="btn-pv-primary btn-sm" onclick="openOrderModal()">
            <i class="fas fa-print me-1"></i>
            Order Prints
        </button>
    </div>

    <p class="text-muted mb-4">Photos you have purchased. You can download or print them.</p>

    <div class="row g-4">
        {% for photo in purchased_photos %}
        <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="photo-card card h-100 purchased">
                <div class="position-relative">
                    <img src="{{ photo.image.url }}"
                         class="card-img-top"
                         alt="{{ photo.category }}">

                    <div class="position-absolute top-0 start-0 m-2">
                        <span class="badge bg-success">
                            <i class="fas fa-check me-1"></i>
                            Purchased
                        </span>
                    </div>

                    <div class="position-absolute top-0 end-0 m-2">
                        <span class="badge bg-info">Digital</span>
                    </div>
                </div>

                <div class="card-body">
                    <h5 class="card-title">{{ photo.category }}</h5>
                    <p class="card-text small text-muted">
                        <i class="fas fa-calendar-alt me-1"></i>
                        Purchased: {{ photo.uploaded_at|date:"M d, Y" }}
                        <br>
                        <i class="fas fa-tag me-1"></i>
                        Category: {{ photo.category }}
                    </p>

                    <div class="d-flex justify-content-between align-items-center">
                        <div class="download-info">
                            <small class="text-success d-block">
                                <i class="fas fa-check-circle me-1"></i>
                                License: Personal Use
                            </small>
                            <small class="text-muted">Expires: Never</small>
                        </div>

                        <div class="btn-group">
                            <a class="btn btn-success btn-sm"
                               href="{{ photo.image.url }}" download>
                                <i class="fas fa-download me-1"></i>
                                Download
                            </a>

                            <button class="btn btn-pv-outline btn-sm">
                                <i class="fas fa-print me-1"></i>
                                Print
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <p class="text-muted">No purchased photos yet.</p>
        {% endfor %}
    </div>
</div>

          
    <!-- Cart Preview (Floating) -->
    <div class="cart-preview position-fixed bottom-0 end-0 m-4 d-none" id="cartPreview">
        <div class="card shadow-lg" style="width: 300px;">
            <div class="card-header bg-pv-deep text-white d-flex justify-content-between align-items-center">
                <span>
                    <i class="fas fa-shopping-cart me-1"></i>
                    Cart Preview
                </span>
                <button class="btn btn-sm btn-outline-light" onclick="hideCartPreview()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="card-body p-3" id="cartPreviewItems">
                <!-- Cart items will be added here dynamically -->
                <p class="text-muted text-center mb-0">No items in cart</p>
            </div>
            <div class="card-footer bg-pv-very-light">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Subtotal:</span>
                    <span class="fw-bold" id="cartPreviewSubtotal">KSH.0.00</span>
                </div>
                <a href="{% url 'cart' %}" class="btn-pv-primary btn-sm w-100">
                    <i class="fas fa-shopping-bag me-1"></i>
                    View Cart
                </a>
            </div>
        </div>
    </div>
</div>

<style>
    /* Gallery-specific styles */
    .gallery-header {
        border-bottom: 2px solid var(--pv-light-green);
    }

    .photo-card {
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }

    .photo-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px var(--shadow-color);
    }

    .photo-card.purchased {
        border-color: var(--pv-light-green);
    }

    .photo-checkbox:checked {
        background-color: var(--pv-light-green);
        border-color: var(--pv-light-green);
    }

    .price-section .text-pv-light {
        color: var(--pv-light-green) !important;
    }

    /* Cart preview styles */
    .cart-preview {
        z-index: 1050;
    }

    .cart-item-mini {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
        border-bottom: 1px solid var(--border-color);
    }

    .cart-item-mini:last-child {
        border-bottom: none;
    }

    .cart-item-mini-img {
        width: 50px;
        height: 40px;
        border-radius: 4px;
        overflow: hidden;
        flex-shrink: 0;
    }

    .cart-item-mini-img img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .cart-item-mini-details {
        flex: 1;
        min-width: 0;
    }

    .cart-item-mini-details h6 {
        margin: 0;
        font-size: 0.9rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .cart-item-mini-details small {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    /* Filter buttons */
    .btn-group .btn.active {
        background-color: var(--pv-light-green);
        border-color: var(--pv-light-green);
        color: white;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .gallery-header {
            padding: 20px 15px;
        }
        
        .btn-group {
            flex-wrap: wrap;
        }
        
        .btn-group .btn {
            font-size: 0.8rem;
            padding: 5px 10px;
        }
        
        .cart-preview {
            position: fixed !important;
            bottom: 10px !important;
            right: 10px !important;
            left: 10px !important;
            width: auto !important;
        }
    }
</style>

<script>
    function showCartPreview() {
    const preview = document.getElementById('cartPreview');

    // Load preview HTML from backend
    fetch('/cart-preview/')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('cartPreviewItems');
            const subtotalEl = document.getElementById('cartPreviewSubtotal');

            if (data.items.length === 0) {
                container.innerHTML = `<p class="text-muted text-center mb-0">No items in cart</p>`;
                subtotalEl.textContent = "KSH.0.00";
            } else {
                let html = '';
                data.items.forEach(item => {
                    html += `
                        <div class="cart-item-mini">
                            <div class="cart-item-mini-img">
                                <img src="${item.image}" alt="">
                            </div>
                            <div class="cart-item-mini-details">
                                <h6>${item.title}</h6>
                                <small>KSH ${item.price}</small>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
                subtotalEl.textContent = "KSH " + data.subtotal;
            }

            preview.classList.remove('d-none');
        });
}

function hideCartPreview() {
    document.getElementById('cartPreview').classList.add('d-none');
}
   // Cart management
document.addEventListener('DOMContentLoaded', function() {
    updateCounts();
    
    // Add event listeners to checkboxes
    document.querySelectorAll('.photo-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateCounts);
    });
});

// Update photo counts
function updateCounts() {
    const previewCount = document.querySelectorAll('#preview-photos .photo-card').length;
    const purchasedCount = document.querySelectorAll('#purchased-photos .photo-card').length;
    const selectedCount = document.querySelectorAll('.photo-checkbox:checked').length;
    
    document.getElementById('preview-count').textContent = previewCount + ' photos';
    
    if (selectedCount > 0) {
        document.querySelector('[onclick="addSelectedToCart()"]').innerHTML = 
            `<i class="fas fa-cart-plus me-1"></i> Add ${selectedCount} to Cart`;
    } else {
        document.querySelector('[onclick="addSelectedToCart()"]').innerHTML = 
            `<i class="fas fa-cart-plus me-1"></i> Add to Cart`;
    }
}

// Add individual photo to cart
function addToCart(button, photoId) {
    const card = button.closest('.photo-card');
    const title = card.querySelector('.card-title').textContent;
    
    fetch('/add-to-cart/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            photo_id: photoId,
            quantity: 1
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            
            // Update cart count in sidebar
            document.getElementById('sidebar-cart-count').textContent = data.cart_count;
            
            // Show cart preview
            showCartPreview();
        } else {
            showNotification('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error adding to cart', 'danger');
    });
}

// Quick buy (purchase immediately)
function quickBuy(button, photoId) {
    if (confirm('Are you sure you want to buy this photo now?')) {
        window.location.href = `/quick-buy/${photoId}/`;
    }
}

// Add selected photos to cart
function addSelectedToCart() {
    const selectedCheckboxes = document.querySelectorAll('.photo-checkbox:checked');
    
    if (selectedCheckboxes.length === 0) {
        showNotification('Please select photos to add to cart', 'warning');
        return;
    }
    
    let addedCount = 0;
    const promises = [];
    
    selectedCheckboxes.forEach(checkbox => {
        const photoId = checkbox.value;
        
        promises.push(
            fetch('/add-to-cart/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    photo_id: photoId,
                    quantity: 1
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addedCount++;
                }
                return data;
            })
        );
    });
    
    Promise.all(promises)
        .then(results => {
            const totalCount = results[results.length - 1].cart_count;
            document.getElementById('sidebar-cart-count').textContent = totalCount;
            
            showNotification(`Added ${addedCount} photos to cart`, 'success');
            
            // Uncheck all checkboxes after adding
            selectedCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            
            updateCounts();
            showCartPreview();
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error adding some photos to cart', 'danger');
        });
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Show notification
function showNotification(message, type) {
    // Remove existing notification
    const existingNotification = document.querySelector('.gallery-notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    // Create notification
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} gallery-notification position-fixed`;
    notification.style.top = '100px';
    notification.style.right = '20px';
    notification.style.zIndex = '9999';
    notification.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        notification.remove();
    }, 3000);
}
</script>
{% endblock %}