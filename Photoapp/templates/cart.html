{% extends "base.html" %}

{% block title %}Shopping Cart - PhotoVault{% endblock %}

{% block auth_buttons %}
    <button class="btn-logout" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i>
        <span class="d-none d-md-inline">Log Out</span>
    </button>
{% endblock %}

{% block sidebar %}
    <nav class="sidebar">
        <div class="sidebar-section">
            <h6 class="sidebar-section-title">Gallery</h6>
            <a href="{% url 'client' %}" class="sidebar-link">
                <i class="fas fa-images"></i>
                <span>Gallery</span>
            </a>
            <a href="{% url 'cart' %}" class="sidebar-link active">
                <i class="fas fa-shopping-cart"></i>
                <span>Cart</span>
                <span class="badge bg-pv-light rounded-pill ms-auto" id="cart-count">{{ cart_items.count }}</span>
            </a>
        </div>
        
        <div class="sidebar-section">
            <h6 class="sidebar-section-title">Orders</h6>
            <a href="{% url 'trackOrder' %}" class="sidebar-link">
                <i class="fas fa-shipping-fast"></i>
                <span>Track Order</span>
            </a>
            <a href="{% url 'orderHistory' %}" class="sidebar-link">
                <i class="fas fa-history"></i>
                <span>Order History</span>
            </a>
        </div>
        
        <div class="sidebar-section">
            <h6 class="sidebar-section-title">Account</h6>
            <a href="#" class="sidebar-link">
                <i class="fas fa-user-cog"></i>
                <span>Profile Settings</span>
            </a>
            <a href="#" class="sidebar-link">
                <i class="fas fa-credit-card"></i>
                <span>Payment Methods</span>
            </a>
        </div>
    </nav>
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <!-- Cart Header -->
    <div class="cart-header bg-pv-very-light py-4 px-4 mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="h2 mb-0 text-pv-deep">
                <i class="fas fa-shopping-cart me-2"></i>
                Shopping Cart
            </h1>
            <div class="d-flex align-items-center gap-3">
                <span class="text-muted" id="item-count">{{ cart_items.count }} item{{ cart_items.count|pluralize }}</span>
                {% if cart_items %}
                <button class="btn-pv-outline btn-sm" onclick="clearCart()">
                    <i class="fas fa-trash-alt me-1"></i>
                    Clear Cart
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Left Column: Cart Items & Shipping Info -->
        <div class="col-lg-8">
            <!-- Cart Items List -->
            <div class="card mb-4">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="bg-pv-very-light">
                                <tr>
                                    <th class="border-0 ps-4" style="width: 60px;">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="select-all" checked onclick="selectAllItems(this)">
                                        </div>
                                    </th>
                                    <th class="border-0">Photo</th>
                                    <th class="border-0 text-center">Type</th>
                                    <th class="border-0 text-center">Quantity</th>
                                    <th class="border-0 text-end">Price</th>
                                    <th class="border-0 text-center pe-4">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="cart-items">
                                {% for item in cart_items %}
                                <tr class="cart-item" data-item-id="{{ item.id }}">
                                    <td class="ps-4">
                                        <div class="form-check">
                                            <input class="form-check-input item-checkbox" type="checkbox" checked data-item-id="{{ item.id }}">
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center gap-3">
                                            <div class="cart-item-image" style="width: 80px; height: 60px;">
                                                <img src="{{ item.photo.image.url }}" 
                                                     alt="{{ item.photo.category }}" 
                                                     class="img-fluid rounded" 
                                                     style="width: 100%; height: 100%; object-fit: cover;">
                                            </div>
                                            <div>
                                                <h6 class="mb-1">{{ item.photo.category }}</h6>
                                                <p class="text-muted mb-0 small">Category: {{ item.photo.category }}</p>
                                                <p class="text-muted mb-0 small">Uploaded: {{ item.photo.uploaded_at|date:"M d, Y" }}</p>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-info">Digital</span>
                                    </td>
                                    <td class="text-center">
                                        <div class="quantity-control d-inline-flex align-items-center">
                                            <button class="btn btn-sm btn-outline-secondary" onclick="decreaseQuantity({{ item.id }})">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                            <input type="number" 
                                                   class="form-control form-control-sm text-center mx-2 quantity-input" 
                                                   value="{{ item.quantity }}" 
                                                   min="1" 
                                                   max="10" 
                                                   style="width: 60px;" 
                                                   data-item-id="{{ item.id }}"
                                                   onchange="updateCartQuantity(this)">
                                            <button class="btn btn-sm btn-outline-secondary" onclick="increaseQuantity({{ item.id }})">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </td>
                                    <td class="text-end">
                                        <div class="item-price">KSH {{ item.photo.price }}</div>
                                        <div class="item-total text-pv-light fw-bold" data-item-id="{{ item.id }}">
                                            KSH {{ item.total_price|floatformat:2 }}
                                        </div>
                                    </td>
                                    <td class="text-center pe-4">
                                        <button class="btn btn-sm btn-outline-danger" onclick="removeCartItem({{ item.id }})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <div class="text-muted">
                                            <i class="fas fa-shopping-cart fa-2x mb-3"></i>
                                            <p class="mb-0">Your cart is empty</p>
                                            <a href="{% url 'client' %}" class="btn-pv-primary btn-sm mt-2">
                                                Browse Photos
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Shipping Information -->
            <div class="card mb-4">
                <div class="card-header bg-pv-very-light">
                    <h5 class="mb-0">
                        <i class="fas fa-shipping-fast me-2"></i>
                        Shipping Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Shipping Address</label>
                            <textarea class="form-control" rows="3" id="shipping-address"></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Shipping Method</label>
                            <select class="form-select" id="shipping-method" onchange="updateCartSummary()">
                                <option value="standard" selected>Standard Shipping (5-7 business days) - KSH 200</option>
                                <option value="express">Express Shipping (2-3 business days) - KSH 500</option>
                                <option value="overnight">Overnight Shipping (1 business day) - KSH 1000</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Contact Email</label>
                            <input type="email" class="form-control" id="contact-email" value="{{ user.email }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="phone-number">
                        </div>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="save-address">
                        <label class="form-check-label" for="save-address">
                            Save this shipping address for future orders
                        </label>
                    </div>
                </div>
            </div>

            <!-- Continue Shopping -->
            <div class="d-flex justify-content-between mb-4">
                <a href="{% url 'client' %}" class="btn-pv-outline">
                    <i class="fas fa-arrow-left me-2"></i>
                    Continue Shopping
                </a>
                {% if cart_items %}
                <button class="btn-pv-outline" onclick="saveForLater()">
                    <i class="far fa-heart me-2"></i>
                    Save for Later
                </button>
                {% endif %}
            </div>
        </div>

        <!-- Right Column: Order Summary -->
        <div class="col-lg-4">
            <div class="card sticky-top" style="top: 100px;">
                <div class="card-header bg-pv-deep text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-receipt me-2"></i>
                        Order Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="order-summary">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal (<span id="summary-item-count">{{ cart_items.count }}</span> items)</span>
                            <span id="subtotal">KSH {{ subtotal|floatformat:2 }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Shipping</span>
                            <span id="shipping-cost">KSH {{ shipping|floatformat:2 }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Tax ({{ tax_rate }}%)</span>
                            <span id="tax">KSH {{ tax|floatformat:2 }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span>Discount</span>
                            <span class="text-success" id="discount">-KSH 0.00</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-4">
                            <h5 class="fw-bold">Total</h5>
                            <h5 class="fw-bold text-pv-light" id="total">KSH {{ total|floatformat:2 }}</h5>
                        </div>

                        <!-- Promo Code -->
                        <div class="mb-4">
                            <label class="form-label">Promo Code</label>
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Enter promo code" id="promo-code">
                                <button class="btn btn-pv-primary" type="button" onclick="applyPromoCode()">
                                    Apply
                                </button>
                            </div>
                            <div class="mt-2">
                                <small class="text-success d-none" id="promo-success">Promo code applied successfully!</small>
                                <small class="text-danger d-none" id="promo-error">Invalid promo code</small>
                            </div>
                        </div>

                        <!-- Payment Methods -->
                        <div class="mb-4">
                            <label class="form-label">Payment Method</label>
                            <div class="payment-methods">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="creditCard" checked>
                                    <label class="form-check-label d-flex align-items-center" for="creditCard">
                                        <i class="fas fa-credit-card me-2"></i>
                                        Credit/Debit Card
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="paypal">
                                    <label class="form-check-label d-flex align-items-center" for="paypal">
                                        <i class="fab fa-paypal me-2"></i>
                                        PayPal
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="applePay">
                                    <label class="form-check-label d-flex align-items-center" for="applePay">
                                        <i class="fab fa-apple me-2"></i>
                                        Apple Pay
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Checkout Button -->
                        {% if cart_items %}
                        <button class="btn-pv-primary btn-lg w-100 mb-3" onclick="proceedToCheckout()">
                            <i class="fas fa-lock me-2"></i>
                            Proceed to Secure Checkout
                        </button>
                        {% else %}
                        <button class="btn-pv-primary btn-lg w-100 mb-3" disabled>
                            <i class="fas fa-lock me-2"></i>
                            Cart is Empty
                        </button>
                        {% endif %}

                        <!-- Security Info -->
                        <div class="text-center">
                            <small class="text-muted d-block mb-2">
                                <i class="fas fa-shield-alt me-1"></i>
                                Secure SSL Encryption
                            </small>
                            <small class="text-muted">
                                <i class="far fa-clock me-1"></i>
                                Digital downloads available immediately after purchase
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Support Info -->
            <div class="card mt-4">
                <div class="card-body text-center">
                    <i class="fas fa-headset fa-2x text-pv-light mb-3"></i>
                    <h6>Need Help?</h6>
                    <p class="small text-muted mb-2">Our support team is here to help</p>
                    <a href="#" class="btn-pv-outline btn-sm">
                        <i class="fas fa-comment-alt me-1"></i>
                        Live Chat
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Cart-specific styles */
    .cart-header {
        border-bottom: 2px solid var(--pv-light-green);
    }

    .cart-item {
        transition: background-color 0.2s ease;
    }

    .cart-item:hover {
        background-color: var(--pv-very-light-green);
    }

    .cart-item-image {
        border-radius: 8px;
        overflow: hidden;
        flex-shrink: 0;
    }

    .quantity-control .btn {
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }

    .item-price {
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    .item-total {
        font-size: 1.1rem;
    }

    .order-summary {
        font-size: 0.95rem;
    }

    .payment-methods {
        background-color: var(--bg-surface);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 15px;
    }

    .form-check-input:checked {
        background-color: var(--pv-light-green);
        border-color: var(--pv-light-green);
    }

    /* Sticky summary on scroll */
    .sticky-top {
        position: sticky;
        z-index: 1020;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .cart-header {
            padding: 20px 15px;
        }
        
        .table-responsive {
            font-size: 0.9rem;
        }
        
        .cart-item-image {
            width: 60px !important;
            height: 45px !important;
        }
        
        .quantity-control input {
            width: 50px !important;
        }
        
        .sticky-top {
            position: static;
        }
    }
</style>

<script>
    // Global variables
    let currentDiscount = 0;
    const taxRate = 8; // 8% tax
    const shippingCosts = {
        'standard': 200,
        'express': 500,
        'overnight': 1000
    };

    document.addEventListener('DOMContentLoaded', function() {
        updateCartSummary();
        
        // Add event listeners
        document.getElementById('shipping-method').addEventListener('change', updateCartSummary);
        document.querySelectorAll('.item-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', updateCartSummary);
        });
    });

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Increase quantity
    function increaseQuantity(itemId) {
        const input = document.querySelector(`.quantity-input[data-item-id="${itemId}"]`);
        if (input) {
            input.value = parseInt(input.value) + 1;
            updateCartQuantity(input);
        }
    }

    // Decrease quantity
    function decreaseQuantity(itemId) {
        const input = document.querySelector(`.quantity-input[data-item-id="${itemId}"]`);
        if (input && parseInt(input.value) > 1) {
            input.value = parseInt(input.value) - 1;
            updateCartQuantity(input);
        }
    }

    // Update quantity via AJAX
    function updateCartQuantity(input) {
        const itemId = input.dataset.itemId;
        const quantity = parseInt(input.value);
        
        if (quantity < 1) {
            removeCartItem(itemId);
            return;
        }
        
        fetch('/update-cart-quantity/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                cart_item_id: itemId,
                quantity: quantity
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update item total
                const itemTotalElement = document.querySelector(`.item-total[data-item-id="${itemId}"]`);
                if (itemTotalElement) {
                    itemTotalElement.textContent = 'KSH ' + data.item_total.toFixed(2);
                }
                
                // Update cart summary
                updateCartSummary();
                showNotification('Quantity updated', 'success');
            } else {
                showNotification('Error updating quantity: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error updating quantity', 'danger');
        });
    }

    // Remove item from cart
    function removeCartItem(itemId) {
        if (confirm('Remove this item from your cart?')) {
            fetch('/remove-from-cart/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    cart_item_id: itemId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove row from table
                    const row = document.querySelector(`.cart-item[data-item-id="${itemId}"]`);
                    if (row) {
                        row.style.opacity = '0.5';
                        setTimeout(() => {
                            row.remove();
                            updateCartSummary();
                            
                            // If cart is empty, reload page
                            if (document.querySelectorAll('.cart-item').length === 0) {
                                location.reload();
                            }
                        }, 300);
                    }
                    
                    // Update cart count
                    document.getElementById('cart-count').textContent = data.cart_count;
                    showNotification('Item removed from cart', 'success');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error removing item', 'danger');
            });
        }
    }

    // Clear entire cart
    function clearCart() {
        if (confirm('Are you sure you want to clear your entire cart?')) {
            window.location.href = '/clear-cart/';
        }
    }

    // Select all items
    function selectAllItems(selectAllCheckbox) {
        const isChecked = selectAllCheckbox.checked;
        document.querySelectorAll('.item-checkbox').forEach(checkbox => {
            checkbox.checked = isChecked;
        });
        updateCartSummary();
    }

    // Update cart summary dynamically
    function updateCartSummary() {
        let subtotal = 0;
        let itemCount = 0;
        let checkedItemCount = 0;
        
        // Calculate subtotal from checked items
        document.querySelectorAll('.cart-item').forEach(row => {
            const checkbox = row.querySelector('.item-checkbox');
            const quantityInput = row.querySelector('.quantity-input');
            const itemTotalText = row.querySelector('.item-total').textContent;
            
            // Count all items
            if (quantityInput) {
                itemCount += parseInt(quantityInput.value);
            }
            
            // Calculate subtotal for checked items
            if (checkbox && checkbox.checked && quantityInput) {
                const itemTotal = parseFloat(itemTotalText.replace('KSH', '').trim());
                subtotal += itemTotal;
                checkedItemCount += parseInt(quantityInput.value);
            }
        });
        
        // Update item counts
        document.getElementById('item-count').textContent = itemCount + ' item' + (itemCount !== 1 ? 's' : '');
        document.getElementById('summary-item-count').textContent = checkedItemCount;
        
        // Get shipping method
        const shippingMethod = document.getElementById('shipping-method').value;
        let shippingCost = shippingCosts[shippingMethod] || 0;
        
        // Apply free shipping for orders over KSH 5000
        if (subtotal >= 5000) {
            shippingCost = 0;
        }
        
        // Calculate tax
        const tax = subtotal * (taxRate / 100);
        
        // Calculate total
        const total = subtotal + shippingCost + tax - currentDiscount;
        
        // Update summary display
        document.getElementById('subtotal').textContent = 'KSH ' + subtotal.toFixed(2);
        document.getElementById('shipping-cost').textContent = shippingCost === 0 ? 'FREE' : 'KSH ' + shippingCost.toFixed(2);
        document.getElementById('tax').textContent = 'KSH ' + tax.toFixed(2);
        document.getElementById('discount').textContent = currentDiscount > 0 ? '-KSH ' + currentDiscount.toFixed(2) : '-KSH 0.00';
        document.getElementById('total').textContent = 'KSH ' + total.toFixed(2);
        
        // Highlight free shipping
        const shippingElement = document.getElementById('shipping-cost');
        if (shippingCost === 0) {
            shippingElement.classList.add('text-success', 'fw-bold');
        } else {
            shippingElement.classList.remove('text-success', 'fw-bold');
        }
    }

    // Apply promo code
    function applyPromoCode() {
        const promoCode = document.getElementById('promo-code').value.toUpperCase();
        const promoSuccess = document.getElementById('promo-success');
        const promoError = document.getElementById('promo-error');
        
        // Hide previous messages
        promoSuccess.classList.add('d-none');
        promoError.classList.add('d-none');
        
        if (!promoCode) {
            promoError.textContent = 'Please enter a promo code';
            promoError.classList.remove('d-none');
            return;
        }
        
        // Define valid promo codes and their discounts
        const validPromoCodes = {
            'PHOTO10': 0.10, // 10% discount
            'WELCOME5': 5.00, // KSH 5 discount
            'SAVE20': 0.20 // 20% discount
        };
        
        if (validPromoCodes.hasOwnProperty(promoCode)) {
            const discountValue = validPromoCodes[promoCode];
            
            // Calculate subtotal for discount
            let subtotal = 0;
            document.querySelectorAll('.cart-item').forEach(row => {
                const checkbox = row.querySelector('.item-checkbox');
                const itemTotalText = row.querySelector('.item-total').textContent;
                if (checkbox && checkbox.checked) {
                    subtotal += parseFloat(itemTotalText.replace('KSH', '').trim());
                }
            });
            
            // Calculate discount amount
            if (discountValue < 1) {
                // Percentage discount
                currentDiscount = subtotal * discountValue;
            } else {
                // Fixed amount discount
                currentDiscount = Math.min(discountValue, subtotal);
            }
            
            promoSuccess.textContent = 'Promo code applied successfully!';
            promoSuccess.classList.remove('d-none');
            updateCartSummary();
            showNotification('Promo code applied!', 'success');
        } else {
            promoError.textContent = 'Invalid promo code';
            promoError.classList.remove('d-none');
        }
    }

    // Save for later
    function saveForLater() {
        const checkedItems = Array.from(document.querySelectorAll('.item-checkbox:checked'))
            .map(checkbox => checkbox.closest('tr'));
        
        if (checkedItems.length === 0) {
            alert('Please select items to save for later');
            return;
        }
        
        // In a real implementation, you would send this to the backend
        // For now, we'll just show a notification
        showNotification(`${checkedItems.length} items saved for later`, 'info');
        
        // You could implement this by creating a "SavedForLater" model
        // or by adding a field to the Cart model
    }

    // Proceed to checkout
    function proceedToCheckout() {
        // Validate shipping info
        const shippingAddress = document.getElementById('shipping-address').value.trim();
        const contactEmail = document.getElementById('contact-email').value.trim();
        
        if (!shippingAddress) {
            alert('Please enter your shipping address');
            return;
        }
        
        if (!contactEmail) {
            alert('Please enter your contact email');
            return;
        }
        
        // Get selected payment method
        const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
        if (!paymentMethod) {
            alert('Please select a payment method');
            return;
        }
        
        // Show loading state
        const checkoutBtn = document.querySelector('.btn-pv-primary.btn-lg');
        const originalText = checkoutBtn.innerHTML;
        checkoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Processing...';
        checkoutBtn.disabled = true;
        
        // Create form data
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
        formData.append('shipping_address', shippingAddress);
        formData.append('contact_email', contactEmail);
        formData.append('payment_method', paymentMethod.id);
        
        // Get selected items
        const selectedItems = [];
        document.querySelectorAll('.item-checkbox:checked').forEach(checkbox => {
            const row = checkbox.closest('tr');
            const itemId = row.dataset.itemId;
            selectedItems.push(itemId);
        });
        
        if (selectedItems.length === 0) {
            alert('Please select at least one item to checkout');
            checkoutBtn.innerHTML = originalText;
            checkoutBtn.disabled = false;
            return;
        }
        
        // Submit form
        fetch('/checkout/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
            } else {
                return response.json();
            }
        })
        .then(data => {
            if (data && data.error) {
                showNotification(data.error, 'danger');
                checkoutBtn.innerHTML = originalText;
                checkoutBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error processing checkout', 'danger');
            checkoutBtn.innerHTML = originalText;
            checkoutBtn.disabled = false;
        });
    }

    // Show notification
    function showNotification(message, type) {
        // Remove existing notification
        const existingNotification = document.querySelector('.cart-notification');
        if (existingNotification) {
            existingNotification.remove();
        }
        
        // Create notification
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'success' ? 'success' : type === 'danger' ? 'danger' : 'info'} cart-notification position-fixed`;
        notification.style.top = '100px';
        notification.style.right = '20px';
        notification.style.zIndex = '9999';
        notification.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
</script>
{% endblock %}