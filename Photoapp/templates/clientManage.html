{% extends "base.html" %}

{% block title %}Manage Clients - PhotoVault Admin{% endblock %}

{% block auth_buttons %}
    <button class="btn-logout" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i>
        <span class="d-none d-md-inline">Log Out</span>
    </button>
{% endblock %}

{% block sidebar %}
    <nav class="sidebar">
        <div class="sidebar-section">
            <h6 class="sidebar-section-title">Dashboard</h6>
            <a href="{% url 'admin' %}" class="sidebar-link">
                <i class="fas fa-tachometer-alt"></i>
                <span>Overview</span>
            </a>
        </div>
        
        <div class="sidebar-section">
            <h6 class="sidebar-section-title">Sales & Analytics</h6>
            <a href="#" class="sidebar-link">
                <i class="fas fa-chart-line"></i>
                <span>Sales Analytics</span>
            </a>
            <a href="#" class="sidebar-link">
                <i class="fas fa-chart-pie"></i>
                <span>Revenue Reports</span>
            </a>
        </div>
        
        <div class="sidebar-section">
            <h6 class="sidebar-section-title">Orders</h6>
            <a href="{% url 'admin_orders' %}" class="sidebar-link">
                <i class="fas fa-shopping-bag"></i>
                <span>Manage Orders</span>
            </a>
            <a href="#" class="sidebar-link">
                <i class="fas fa-clock"></i>
                <span>Pending Orders</span>
            </a>
        </div>
        
        <div class="sidebar-section">
            <h6 class="sidebar-section-title">Payments</h6>
            <a href="#" class="sidebar-link">
                <i class="fas fa-credit-card"></i>
                <span>Payment Processing</span>
            </a>
            <a href="#" class="sidebar-link">
                <i class="fas fa-receipt"></i>
                <span>Transactions</span>
            </a>
        </div>
        
        <div class="sidebar-section">
            <h6 class="sidebar-section-title">Clients</h6>
            <a href="{% url 'clientManage' %}" class="sidebar-link active">
                <i class="fas fa-users"></i>
                <span>Client Management</span>
                <span class="badge bg-pv-light rounded-pill ms-auto" id="total-clients-count">{{ total_clients }}</span>
            </a>
            <a href="#" class="sidebar-link" onclick="openAddClientModal()">
                <i class="fas fa-user-plus"></i>
                <span>Add New Client</span>
            </a>
        </div>
        
        <div class="sidebar-section">
            <h6 class="sidebar-section-title">Content</h6>
            <a href="{% url 'upload_photos' %}" class="sidebar-link">
                <i class="fas fa-upload"></i>
                <span>Upload Photos</span>
            </a>
              <a href="{% url 'admin_contact_messages' %}" class="sidebar-link active">
                <i class="fas fa-envelope"></i>
                <span>Contact Messages</span>
                {% if new_count %}
                <span class="badge bg-danger rounded-pill ms-auto">{{ new_count }}</span>
                {% endif %}
            </a>
        </div>
    </nav>
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <!-- Clients Header -->
    <div class="clients-header bg-pv-very-light py-4 px-4 mb-4">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
            <div>
                <h1 class="h2 mb-0 text-pv-deep">
                    <i class="fas fa-users me-2"></i>
                    Client Management
                </h1>
                <p class="text-muted mb-0 mt-2">Manage all client accounts, view details, and assign photos</p>
            </div>
            <div class="d-flex align-items-center gap-3 mt-2 mt-md-0">
                <div class="input-group" style="max-width: 300px;">
                    <input type="text" class="form-control" placeholder="Search clients..." id="client-search">
                    <button class="btn btn-pv-primary" onclick="searchClients()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <button class="btn-pv-primary" onclick="openAddClientModal()">
                    <i class="fas fa-user-plus me-2"></i>
                    Add Client
                </button>
                <button class="sidebar-toggle d-lg-none" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Client Statistics -->
    <div class="row mb-4 g-4">
        <div class="col-xl-3 col-md-6">
            <div class="card h-100">
                <div class="card-body text-center">
                    <div class="client-stat-icon mb-3">
                        <i class="fas fa-users fa-2x text-pv-light"></i>
                    </div>
                    <h3 class="client-stat-number">{{ total_clients }}</h3>
                    <p class="client-stat-label text-muted">Total Clients</p>
                    <div class="client-stat-change text-success">
                        <i class="fas fa-chart-line me-1"></i>
                        {{ customer_count }} in system
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card h-100">
                <div class="card-body text-center">
                    <div class="client-stat-icon mb-3">
                        <i class="fas fa-star fa-2x text-warning"></i>
                    </div>
                    <h3 class="client-stat-number">{{ active_clients }}</h3>
                    <p class="client-stat-label text-muted">Active This Month</p>
                    <div class="client-stat-change text-success">
                        <i class="fas fa-chart-line me-1"></i>
                        {% if active_clients > 0 %}Active{% else %}No activity{% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card h-100">
                <div class="card-body text-center">
                    <div class="client-stat-icon mb-3">
                        <i class="fas fa-shopping-bag fa-2x text-info"></i>
                    </div>
                    <h3 class="client-stat-number">KSH {{ total_revenue|floatformat:2 }}</h3>
                    <p class="client-stat-label text-muted">Total Revenue</p>
                    <div class="client-stat-change text-success">
                        <i class="fas fa-chart-line me-1"></i>
                        All time revenue
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card h-100">
                <div class="card-body text-center">
                    <div class="client-stat-icon mb-3">
                        <i class="fas fa-redo fa-2x text-success"></i>
                    </div>
                    <h3 class="client-stat-number">{{ repeat_rate }}%</h3>
                    <p class="client-stat-label text-muted">Repeat Purchase Rate</p>
                    <div class="client-stat-change {% if repeat_rate > 30 %}text-success{% else %}text-warning{% endif %}">
                        <i class="fas fa-chart-line me-1"></i>
                        {% if repeat_rate > 50 %}Excellent{% elif repeat_rate > 30 %}Good{% else %}Needs improvement{% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Clients Table -->
    <div class="card mb-4">
        <div class="card-header bg-pv-very-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0">All Clients ({{ customer_count }})</h5>
            <div class="d-flex gap-2">
                <div class="dropdown">
                    <button class="btn btn-pv-outline btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-filter me-1"></i>
                        Filter
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="filterClients('all')">All Clients</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="filterClients('active')">Active</a></li>
                        <li><a class="dropdown-item" href="#" onclick="filterClients('inactive')">Inactive</a></li>
                        <li><a class="dropdown-item" href="#" onclick="filterClients('premium')">Premium</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="filterClients('new')">New This Month</a></li>
                    </ul>
                </div>
                <button class="btn btn-pv-primary btn-sm" onclick="exportClients()">
                    <i class="fas fa-file-export me-1"></i>
                    Export
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr class="bg-pv-very-light">
                            <th class="ps-4" style="width: 50px;">
                                <input type="checkbox" class="form-check-input" id="select-all-clients" onchange="toggleSelectAllClients()">
                            </th>
                            <th>Client</th>
                            <th>Contact</th>
                            <th>Status</th>
                            <th>Photos</th>
                            <th>Orders</th>
                            <th>Total Spent</th>
                            <th class="pe-4 text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="clients-table">
                        {% for customer in customers %}
                        <tr class="client-row" 
                            data-status="{% if customer.is_active %}active{% else %}inactive{% endif %}" 
                            data-tier="{{ customer.tier }}"
                            data-new="{% if customer.is_new %}true{% else %}false{% endif %}"
                            data-client-id="{{ customer.user.id }}">
                            <td class="ps-4">
                                <input type="checkbox" class="form-check-input client-checkbox" value="{{ customer.user.id }}">
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="client-avatar me-3">
                                        <div class="avatar-placeholder bg-pv-light text-white">
                                            {{ customer.user.first_name|first|upper }}{{ customer.user.last_name|first|upper }}
                                        </div>
                                    </div>
                                    <div>
                                        <h6 class="mb-1">{{ customer.user.get_full_name|default:customer.user.username }}</h6>
                                        <small class="text-muted">Client ID: {{ customer.client_id }}</small>
                                        <div>
                                            <span class="badge bg-{{ customer.tier_class }}">
                                                {{ customer.tier|title }}
                                            </span>
                                            <span class="badge bg-{{ customer.status_class }}">
                                                {{ customer.status_text }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div>
                                    <div class="fw-medium">{{ customer.user.email }}</div>
                                    <small class="text-muted">{{ customer.profile.phone|default:"No phone" }}</small>
                                </div>
                            </td>
                            <td>
                                <div class="status-indicator {% if customer.is_active %}active{% elif customer.is_new %}new{% else %}inactive{% endif %}"></div>
                                <small>
                                    {% if customer.last_order_date %}
                                    Last order: {{ customer.last_order_date|date:"M d, Y" }}
                                    {% elif customer.last_activity %}
                                    Last active: {{ customer.last_activity|date:"M d, Y" }}
                                    {% else %}
                                    Registered: {{ customer.user.date_joined|date:"M d, Y" }}
                                    {% endif %}
                                </small>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-images me-2 text-pv-light"></i>
                                    <div>
                                        <div class="fw-medium">{{ customer.total_photos }} photos</div>
                                        <small class="text-muted">{{ customer.purchased_photos }} purchased</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div>
                                    <div class="fw-medium">{{ customer.total_orders }} orders</div>
                                    {% if customer.last_order_date %}
                                    <small class="text-muted">Last: {{ customer.last_order_date|date:"M d, Y" }}</small>
                                    {% else %}
                                    <small class="text-muted">No orders yet</small>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <div class="fw-bold text-pv-light">KSH {{ customer.total_spent|floatformat:2 }}</div>
                                {% if customer.total_orders > 0 %}
                                <small class="text-muted">
                                    Avg: KSH {{ customer.avg_order_value|floatformat:2 }}/order
                                </small>
                                {% endif %}
                            </td>
                            <td class="pe-4 text-end">
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-secondary" onclick="viewClientDetails({{ customer.user.id }})">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="editClient({{ customer.user.id }})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-pv-outline" onclick="assignPhotos({{ customer.user.id }})">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="text-center py-5">
                                <div class="text-muted">
                                    <i class="fas fa-users fa-3x mb-3"></i>
                                    <h5>No clients found</h5>
                                    <p class="mb-0">Your customers will appear here.</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer bg-pv-very-light">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <button class="btn btn-sm btn-pv-outline me-2" onclick="bulkAssignPhotos()">
                        <i class="fas fa-plus me-1"></i>
                        Assign Photos to Selected
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteSelectedClients()">
                        <i class="fas fa-trash me-1"></i>
                        Delete Selected
                    </button>
                </div>
                <div class="text-muted">
                    <small>Total Revenue: <strong class="text-pv-light">KSH {{ total_revenue|floatformat:2 }}</strong></small>
                </div>
            </div>
        </div>
    </div>

    <!-- Client Activity & Tier Distribution -->
    <div class="row mb-4 g-4">
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header bg-pv-very-light">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2 text-pv-light"></i>
                        Client Activity Overview
                    </h5>
                </div>
                <div class="card-body">
                    <div class="activity-stats">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="activity-stat">
                                    <div class="activity-number text-pv-light">{{ active_clients }}</div>
                                    <div class="activity-label">Active Clients</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="activity-stat">
                                    <div class="activity-number text-info">{{ total_clients|add:"-active_clients" }}</div>
                                    <div class="activity-label">Inactive Clients</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="activity-stat">
                                    <div class="activity-number text-success">{{ total_clients }}</div>
                                    <div class="activity-label">Total in System</div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4">
                            <h6>Recent Activity</h6>
                            <div class="list-group">
                                {% for customer in customers %}
                                {% if forloop.counter <= 3 %}
                                <div class="list-group-item list-group-item-action">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">{{ customer.user.get_full_name|default:customer.user.username }}</h6>
                                        <small class="text-muted">
                                            {% if customer.last_order_date %}
                                            {{ customer.last_order_date|timesince }} ago
                                            {% elif customer.last_activity %}
                                            {{ customer.last_activity|timesince }} ago
                                            {% else %}
                                            Never
                                            {% endif %}
                                        </small>
                                    </div>
                                    <p class="mb-1">
                                        {% if customer.total_orders > 0 %}
                                        {{ customer.total_orders }} orders â€¢ KSH {{ customer.total_spent|floatformat:2 }} spent
                                        {% else %}
                                        No orders yet
                                        {% endif %}
                                    </p>
                                </div>
                                {% endif %}
                                {% empty %}
                                <div class="list-group-item">
                                    <p class="mb-0 text-muted">No recent client activity</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header bg-pv-very-light">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2 text-pv-light"></i>
                        Client Tier Distribution
                    </h5>
                </div>
                <div class="card-body">
                    <div class="tier-distribution">
                        <div class="tier-chart">
                            <div class="tier-chart-bar premium" style="width: {% widthratio premium_clients total_clients 100 %}%">
                                <span class="tier-label">Premium</span>
                                <span class="tier-percentage">{{ premium_clients }}</span>
                            </div>
                            <div class="tier-chart-bar standard" style="width: {% widthratio standard_clients total_clients 100 %}%">
                                <span class="tier-label">Standard</span>
                                <span class="tier-percentage">{{ standard_clients }}</span>
                            </div>
                        </div>
                        <div class="row mt-3 text-center">
                            <div class="col-6">
                                <div class="tier-stat">
                                    <div class="tier-number text-pv-light">{{ premium_clients }}</div>
                                    <div class="tier-label">Premium Clients</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="tier-stat">
                                    <div class="tier-number text-secondary">{{ standard_clients }}</div>
                                    <div class="tier-label">Standard Clients</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="card">
        <div class="card-header bg-pv-very-light">
            <h5 class="mb-0">
                <i class="fas fa-bolt me-2"></i>
                Quick Client Actions
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 col-6 mb-3">
                    <button class="btn btn-pv-outline w-100 h-100 p-3" onclick="sendBulkEmail()">
                        <i class="fas fa-envelope fa-2x mb-2"></i>
                        <div>Send Email</div>
                        <small class="text-muted">To all active clients</small>
                    </button>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <button class="btn btn-pv-outline w-100 h-100 p-3" onclick="createClientSegment()">
                        <i class="fas fa-object-group fa-2x mb-2"></i>
                        <div>Create Segment</div>
                        <small class="text-muted">Group clients by criteria</small>
                    </button>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <button class="btn btn-pv-outline w-100 h-100 p-3" onclick="generateClientReport()">
                        <i class="fas fa-file-export fa-2x mb-2"></i>
                        <div>Export Report</div>
                        <small class="text-muted">Client analytics data</small>
                    </button>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <button class="btn btn-pv-outline w-100 h-100 p-3" onclick="manageSubscriptions()">
                        <i class="fas fa-id-card fa-2x mb-2"></i>
                        <div>Manage Subscriptions</div>
                        <small class="text-muted">Upgrade/downgrade tiers</small>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Client Modal -->
<div class="modal fade" id="addClientModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Client</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addClientForm" method="POST">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">First Name *</label>
                            <input type="text" class="form-control" name="first_name" required 
                                   placeholder="Enter your first name" 
                                   value="{{ first_name|default:'' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Last Name *</label>
                            <input type="text" class="form-control" name="last_name" required 
                                   placeholder="Enter your last name" 
                                   value="{{ last_name|default:'' }}">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Username *</label>
                            <input type="text" class="form-control" name="username" required 
                                   placeholder="Choose a username" 
                                   value="{{ username|default:'' }}">
                            <small class="form-text text-muted">
                                This will be your public display name
                            </small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email Address *</label>
                            <input type="email" class="form-control" name="email" required 
                                   placeholder="Enter your email address" 
                                   value="{{ email|default:'' }}">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" name="phone" 
                                   placeholder="Optional phone number" 
                                   value="{{ phone|default:'' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Account Type *</label>
                            <select class="form-select" name="user_type" required>
    <option value="">Select account type</option>

    {% for value, label in profile_choices %}
        <option value="{{ value }}" 
            {% if user_type == value %}selected{% endif %}>
            {{ label }}
        </option>
    {% endfor %}
</select> 
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Password *</label>
                            <input type="password" class="form-control" name="password" required 
                                   placeholder="Create a password" 
                                   value="{{ password|default:'' }}">
                            <small class="form-text text-muted">
                            
                            </small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Confirm Password *</label>
                            <input type="password" class="form-control" name="confirm_password" required 
                                   placeholder="Confirm your password" 
                                   value="{{ confirm_password|default:'' }}">
                        </div>
                    </div>
                    
                    
                    
                     <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn-pv-primary btn-lg">Add Client</button>
                    </div>
                    
                  
                </form>
            </div>
            
        </div>
    </div>
</div>

<style>
    /* Clients Management specific styles */
    .clients-header {
        border-bottom: 2px solid var(--pv-light);
    }

    .client-stat-icon {
        color: var(--pv-light);
    }

    .client-stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        line-height: 1;
        margin: 10px 0;
    }

    .client-stat-label {
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    .client-stat-change {
        font-size: 0.85rem;
        margin-top: 5px;
    }

    .client-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        overflow: hidden;
        flex-shrink: 0;
    }

    .client-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-placeholder {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.9rem;
        background-color: var(--pv-light);
        color: white;
    }

    .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 5px;
    }

    .status-indicator.active {
        background-color: var(--pv-light);
        box-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
    }

    .status-indicator.inactive {
        background-color: #ffc107;
    }

    .status-indicator.new {
        background-color: #17a2b8;
        box-shadow: 0 0 5px rgba(23, 162, 184, 0.5);
    }

    .client-row:hover {
        background-color: rgba(76, 175, 80, 0.05);
        cursor: pointer;
    }

    /* Badge color classes */
    .bg-pv-light {
        background-color: var(--pv-light) !important;
        color: white !important;
    }

    .bg-info {
        background-color: #17a2b8 !important;
        color: white !important;
    }

    .bg-success {
        background-color: #28a745 !important;
        color: white !important;
    }

    .bg-warning {
        background-color: #ffc107 !important;
        color: #212529 !important;
    }

    .bg-secondary {
        background-color: #6c757d !important;
        color: white !important;
    }

    /* Activity stats */
    .activity-stat {
        padding: 15px;
    }

    .activity-number {
        font-size: 2rem;
        font-weight: bold;
        line-height: 1;
    }

    .activity-label {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 5px;
    }

    /* Tier distribution chart */
    .tier-chart {
        height: 40px;
        background: #e9ecef;
        border-radius: 20px;
        overflow: hidden;
        display: flex;
        margin: 20px 0;
    }

    .tier-chart-bar {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 15px;
        color: white;
        font-weight: bold;
        transition: width 0.5s ease;
    }

    .tier-chart-bar.premium {
        background-color: var(--pv-light);
    }

    .tier-chart-bar.standard {
        background-color: #6c757d;
    }

    .tier-percentage {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .tier-stat {
        padding: 10px;
    }

    .tier-number {
        font-size: 2rem;
        font-weight: bold;
        line-height: 1;
    }

    .tier-label {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 5px;
    }

    /* Notification */
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .clients-header {
            padding: 20px 15px;
        }
        
        .client-stat-number {
            font-size: 2rem;
        }
        
        .table-responsive {
            font-size: 0.9rem;
        }
        
        .btn-group-sm .btn {
            padding: 0.2rem 0.4rem;
            font-size: 0.8rem;
        }
        
        .client-avatar {
            width: 35px;
            height: 35px;
        }
        
        .avatar-placeholder {
            width: 35px;
            height: 35px;
        }
        
        .activity-number, .tier-number {
            font-size: 1.5rem;
        }
    }

    @media (max-width: 576px) {
        .card-footer .btn {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }
        
        .pagination {
            font-size: 0.8rem;
        }
        
        .client-stat-number {
            font-size: 1.5rem;
        }
    }
</style>

<script>
    // Initialize event listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Search functionality
        const searchInput = document.getElementById('client-search');
        if (searchInput) {
            searchInput.addEventListener('input', function(e) {
                searchClients(e.target.value);
            });
        }
        
        // Update client counts
        updateClientCounts();
    });

    // Update client counts
    function updateClientCounts() {
        const totalClients = {{ total_clients }};
        const activeClients = {{ active_clients }};
        
        // Update sidebar badge
        const sidebarBadge = document.getElementById('total-clients-count');
        if (sidebarBadge) {
            sidebarBadge.textContent = totalClients;
        }
    }

    // Search clients
    function searchClients(query = null) {
        if (!query) {
            query = document.getElementById('client-search').value;
        }
        
        const rows = document.querySelectorAll('.client-row');
        let count = 0;
        
        rows.forEach(row => {
            const clientName = row.querySelector('h6').textContent.toLowerCase();
            const clientEmail = row.querySelector('.fw-medium').textContent.toLowerCase();
            const clientId = row.querySelector('.text-muted').textContent.toLowerCase();
            
            const searchText = (clientName + clientEmail + clientId).toLowerCase();
            const show = !query || searchText.includes(query.toLowerCase());
            
            row.classList.toggle('d-none', !show);
            if (show) count++;
        });
        
        showNotification(`Found ${count} clients`, 'info');
    }

    // Filter clients
    function filterClients(filterType) {
        const rows = document.querySelectorAll('.client-row');
        let visibleCount = 0;
        
        rows.forEach(row => {
            let shouldShow = false;
            
            switch(filterType) {
                case 'all':
                    shouldShow = true;
                    break;
                case 'active':
                    shouldShow = row.dataset.status === 'active';
                    break;
                case 'inactive':
                    shouldShow = row.dataset.status === 'inactive';
                    break;
                case 'premium':
                    shouldShow = row.dataset.tier === 'premium';
                    break;
                case 'new':
                    shouldShow = row.dataset.new === 'true';
                    break;
            }
            
            if (shouldShow) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        showNotification(`Showing ${visibleCount} clients`, 'info');
    }

    // Toggle select all clients
    function toggleSelectAllClients() {
        const selectAll = document.getElementById('select-all-clients');
        const checkboxes = document.querySelectorAll('.client-checkbox');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
    }

    // Bulk assign photos to selected clients
    function bulkAssignPhotos() {
        const selectedIds = Array.from(document.querySelectorAll('.client-checkbox:checked'))
            .map(cb => cb.value);
        
        if (selectedIds.length === 0) {
            showNotification('Please select at least one client', 'warning');
            return;
        }
        
        // Redirect to upload photos page with selected clients
        window.location.href = `{% url 'upload_photos' %}?clients=${selectedIds.join(',')}`;
    }

    // Delete selected clients
    function deleteSelectedClients() {
        const selectedIds = Array.from(document.querySelectorAll('.client-checkbox:checked'))
            .map(cb => cb.value);
        
        if (selectedIds.length === 0) {
            showNotification('Please select at least one client', 'warning');
            return;
        }
        
        if (confirm(`Are you sure you want to delete ${selectedIds.length} selected client(s)?`)) {
            // AJAX request to delete clients
            fetch('clients/delete/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ client_ids: selectedIds })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(`${data.deleted_count} client(s) deleted successfully`, 'success');
                    // Remove deleted rows from table
                    selectedIds.forEach(id => {
                        const row = document.querySelector(`tr[data-client-id="${id}"]`);
                        if (row) row.remove();
                    });
                    updateClientCounts();
                } else {
                    showNotification('Error: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error deleting clients', 'danger');
            });
        }
    }

    // View client details
    function viewClientDetails(clientId) {
        window.location.href = `client/${clientId}/`;
    }

    // Edit client
    function editClient(clientId) {
        window.location.href = `client/${clientId}/edit/`;
    }

    // Assign photos to client
    function assignPhotos(clientId) {
        window.location.href = `{% url 'upload_photos' %}?client_id=${clientId}`;
    }

    // Export clients data
    function exportClients() {
        showNotification('Export feature coming soon!', 'info');
    }

    // Open add client modal
    function openAddClientModal() {
        const modal = new bootstrap.Modal(document.getElementById('addClientModal'));
        modal.show();
    }

    // Submit add client form
    function submitAddClient() {
        const form = document.getElementById('addClientForm');
        const formData = new FormData(form);
        
        // Basic validation
        if (!formData.get('first_name') || !formData.get('last_name') || 
            !formData.get('email') || !formData.get('username') || !formData.get('password')) {
            showNotification('Please fill all required fields', 'warning');
            return;
        }
        
        showNotification('Adding new client...', 'info');
        
        // Simulate API call
        setTimeout(() => {
            const modal = bootstrap.Modal.getInstance(document.getElementById('addClientModal'));
            modal.hide();
            showNotification('New client added successfully', 'success');
            // In a real app, you would reload the page or update the table via AJAX
            setTimeout(() => location.reload(), 1000);
        }, 1500);
    }

    // Quick action functions
    function sendBulkEmail() {
        showNotification('Opening bulk email composer...', 'info');
    }

    function createClientSegment() {
        showNotification('Creating client segment...', 'info');
    }

    function generateClientReport() {
        showNotification('Generating client analytics report...', 'info');
    }

    function manageSubscriptions() {
        showNotification('Opening subscription management...', 'info');
    }

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Show notification
    function showNotification(message, type = 'info') {
        // Remove existing notifications
        document.querySelectorAll('.notification').forEach(n => n.remove());
        
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show notification`;
        notification.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 
                                type === 'warning' ? 'fa-exclamation-triangle' : 
                                type === 'danger' ? 'fa-times-circle' : 'fa-info-circle'} me-2"></i>
                <span>${message}</span>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
    }

    // Logout function
    function logout() {
        window.location.href = "{% url 'logout' %}";
    }

    // Toggle sidebar for mobile
    function toggleSidebar() {
        const sidebar = document.querySelector('.sidebar');
        sidebar.classList.toggle('show');
    }
</script>
{% endblock %}